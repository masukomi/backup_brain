#!/usr/bin/env bash

# Exit on error
set -e

trap ctrl_c INT

function ctrl_c() {
 pids=$(ps -ef | grep delayed_job | grep -v grep | awk '{print $2}')
 while [ "$pids" != ""  ]; do
   echo "Killing Delayed Job Workers"
   ps -ef | grep delayed_job | grep -v grep | awk '{print $2}' | xargs kill
   pids=$(ps -ef | grep delayed_job | grep -v grep | awk '{print $2}')
 done
}

# Make sure you've defined a host name
hostname=$(cat .env | grep "^HOST_NAME" | sed -e "s/HOST_NAME=//" -e "s/#.*//")
if [ -z "$hostname" ]; then
  echo "HOST_NAME is not set"
  echo "Set it in the .env file"
  echo "By default you probably want to set it to 'localhost'"
  echo "ex: HOST_NAME=localhost"
  echo "Check the README ways to give it a better name."
  exit 78 # EX_CONFIG (78)  Something was found in an unconfigured or misconfigured state.
else
  echo "HOST_NAME is set to \"$hostname\""
  echo "If this is not correct please update the .env file"
  echo "It will effect your ability to log in."
fi

# Make sure you've defined a port (defaults in .env.sample is 3334)
port=$(cat .env | grep "^PORT" | sed -e "s/PORT=//" -e "s/#.*//")
if [ -z "$port" ]; then
  echo "PORT is not set"
  echo "Set it in the .env file"
  echo "By default you probably want to set it to 3334"
  echo "ex: PORT=3334"
  echo "Lots of development tools use 3000, so this won't interfere with them."
  exit 78 # EX_CONFIG (78)  Something was found in an unconfigured or misconfigured state.
else
  echo "PORT is set to \"$port\""
  echo "If this is not correct please update the .env file"
fi

# Test if meilisearch is running
if [[ $OSTYPE == "darwin"* ]]; then
  ps -ax | grep meili | grep -v 'grep' > /dev/null
else
  ps -AH S | grep meili | grep -v 'grep' > /dev/null
fi
#Start it if it isn't.
if [ $? -ne 0 ]; then
  echo "booting meilisearch too..."
  api_key=$(cat .env | grep "^MEILISEARCH_API_KEY" | sed -e "s/MEILISEARCH_API_KEY=//" -e "s/#.*//")
  if [ -z "$api_key" ]; then
    echo "MEILISEARCH_API_KEY is not set"
    echo "Start it without one to have one autogenerated, copy the key it shows."
    echo "Then store it in the .env file where noted"
    echo "start it by running `meilisearch` with no arguments"
    exit 78 # EX_CONFIG (78)  Something was found in an unconfigured or misconfigured state.
  fi
  meilisearch --master-key "$api_key"  > /dev/null 2>&1 &
  disown
else
  echo "meilisearch is already running"
fi


# Make sure you've defined a port (defaults in .env.sample is 3334)
worker_count=$(cat .env | grep "^DELAYED_JOB_WORKERS" | sed -e "s/DELAYED_JOB_WORKERS=//" -e "s/#.*//")
if [ -z "$worker_count" ]; then
  echo "DELAYED_JOB_WORKERS is not set"
  echo "Will use 2 workers by default."
  echo "Configure this as an integer in your .env file"
  worker_count=2
else
  echo "DELAYED_JOB_WORKERS is set to \"$worker_count\""
  echo "If this is not correct please update the .env file"
fi

echo "Starting $worker_count Delayed Job Workers"
# Start the Delayed Job Workers
bin/delayed_job -n $worker_count start & disown



echo "Starting Rails Server on port $port"
# Start Rails
bundle exec rails server -p $port




#TODO nothing in delayed_job_pids
#TODO maybe background the rails server too?
